<!DOCTYPE html>
<html>
<head>
  <title>文件管理器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <script type="text/javascript" src="/lib/import-core.js?v=2020.03.15"></script>
  <script type="text/javascript" src="/lib/apis/fsapi.js?v=2020.03.15"></script>
  <script type="text/javascript" src="/lib/apis/userapi.js?v=2020.03.15"></script>
  <script type="text/javascript" src="/lib/apis/preview.js?v=2020.03.15"></script>
  <style type="text/css">
    .ivu-layout{
      height:100%;
    }
    .usermanagetab .ivu-tabs-content{
      height: calc(100% - 33px - 16px);
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="layout">
      <Layout>
          <Sider width="120" v-model="isCollapsed">
            <div style="padding: 8px;text-align: center;">
              <Dropdown @on-click='onDropdownClick' transfer>
                <div>
                  <Icon type="md-flower" class="cs_p" :style="{'font-size':'48px',color:'#c9ccd0'}"></Icon>
                  <a href="javascript:void(0)" class="d_block mg_b_5" style="color: rgb(201, 204, 208);line-height: 20px;">{{currentAccount.UserName}}</a>
                </div>
                  <Dropdown-Menu slot="list">
                      <Dropdown-Item name='logout'>注销登陆</Dropdown-Item>
                  </Dropdown-Menu>
              </Dropdown>
            </div>
            <i-menu active-name="menu-files" theme="dark" width="auto" :class="menuitemClasses">
                <Menu-Item name="menu-files" to="/files">
                    <Icon type="ios-navigate"></Icon>
                    <span>文件</span>
                </Menu-Item>
                <Menu-Item name="menu-setting" to="/settings">
                    <Icon type="ios-settings"></Icon>
                    <span>设置</span>
                </Menu-Item>
            </i-menu>
            <div slot="trigger"></div>
          </Sider>
          <Layout>
              <i-content :style="{background: '#fff', minHeight: '220px', height:'100%'}">
                <router-view></router-view>
              </i-content>
          </Layout>
        </Layout>
    </div>
  </div>
  
  <!-- 文件列表 -->
  <template id="fslist">
    <div style="height: 100%">
      <div style="padding: 5px 20px;">
          <div>
              <i-button type="default" v-show="fsOperationButtons.shows.upload" @click="fsUpload.showDrawer = true">上传</i-button>
              <i-button type="default" v-show="fsOperationButtons.shows.newFolder" @click="onNewFolder">新建文件夹</i-button>
              <i-button type="default" v-show="fsOperationButtons.shows.download" @click="doDownload">下载</i-button>
              <i-button type="default" v-show="fsOperationButtons.shows.rename" @click="onRename">重命名</i-button>
              <i-button type="default" v-show="fsOperationButtons.shows.delete" @click="doDelete">删除</i-button>
              <i-button type="default" v-show="fsOperationButtons.shows.move" @click="doMove">移动</i-button>
              <i-button type="default" v-show="fsOperationButtons.shows.copy" @click="doCopy">复制</i-button>
          </div>
      </div>
      <div style="height: 30px;line-height: 30px;background: #f8f8f9;padding-left: 20px;">
        <a href="javascript:void(0)" class="fl mg_r_5 fs_14" @click="doRefresh">刷新</a>
        <fs-address :rootname="fsAddress.rootname" :path="fsAddress.loadPath" @click="goToPath"></fs-address>
      </div>
      <i-table ref="fsSelection" v-minus-height="120" :loading="loading" :columns="fsColumns" :data="fsData"
        highlight-row="true" @on-row-click="onRowClick" @on-selection-change="onSelectionChange" ></i-table>
      <Page show-total :total="fsData_Total" size="small" :current='fsData_CurrentPageIndex' :page-size="fsData_PageSize" style="line-height: 45px;background: #FFF;float: right;padding: 0px 45px;" @on-change="loadDatePage"></Page>
       <!-- 上传文件 -->
      <Drawer title="上传文件" width="450px" :closable="false" v-model="fsUpload.showDrawer">
        <div class="ivu-upload">
          <div class="ivu-upload ivu-upload-drag" ref="uploadDrag" @click="doSelectFiels">
            <input ref="upload_selector_file" type="file" multiple="multiple" class="ivu-upload-input">
            <div style="padding: 20px 0px;">
              <i class="ivu-icon ivu-icon-ios-cloud-upload" style="font-size: 52px; color: rgb(51, 153, 255);"></i>
              <p>Click here to upload</p>
            </div>
          </div> 
          <ul class="ivu-upload-list">
            <li v-for="temp in fsUpload.files" v-if="!temp._upload.removed" class="ivu-upload-list-file">
              <span>{{temp.name}}</span>
              <i class="ivu-icon ivu-icon-ios-close ivu-upload-list-remove" @click="removeTask(temp._upload.index)"></i>
              <div class="ivu-progress ivu-progress-normal ivu-progress-show-info">
                <div class="ivu-progress-outer">
                  <div class="ivu-progress-inner">
                    <div v-if="!temp._upload.ps||temp._upload.ps<100" class="ivu-progress-bg" :style="{width: (temp._upload.ps?temp._upload.ps:0)+'%', height: '2px'}"></div>
                    <div v-else class="ivu-progress-success-bg" style="width: 100%; height: 2px;"></div>
                  </div>
                </div> 
                <span class="ivu-progress-text">
                  <span :style="{color: temp._upload.err?'#b42525':'#515a6e'}" class="ivu-progress-text-inner">{{temp._upload.err?temp._upload.err:temp._upload.ps+'%'}}</span>
                </span>
              </div>
            </li>
          </ul>
        </div>
      </Drawer>
      <!-- 复制文件 -->
      <fs-copyfile :src-paths="fsCopyFile.srcPaths" :dest-path="fsCopyFile.destPath" :copy-settings="fsCopyFile.copySettings" :show-dailog="fsCopyFile.showDailog" @on-stop="even_StopCopy" @on-end="even_EndCopy"></fs-copyfile>
      <!-- 移动文件 -->
      <fs-movefile :src-paths="fsMoveFile.srcPaths" :dest-path="fsMoveFile.destPath" :move-settings="fsMoveFile.moveSettings" :show-dailog="fsMoveFile.showDailog" @on-stop="even_StopMove" @on-end="even_EndMove"></fs-movefile>
        <!-- 选择目录 -->
      <fs-selector :select-muti="fsSelector.selectMuti" :select-file="fsSelector.selectFile" :select-dir="fsSelector.selectDir" :start-path="fsSelector.startPath" :show-dailog="fsSelector.showDailog" @on-select="onSelectedFile" @on-cancel="onSelectCancel"></fs-selector>
    </div>
  </template>

  <!-- 系统设置 -->
  <template id="settings">
    <div class='pd_10_10' style="height: 100%;">
      <Tabs class="usermanagetab" v-model='currentTab' size="small" style='height:100%;'>
        <Tab-Pane name='currentAccount' label="账户信息">
          <!-- <div class="mg_0_auto" style="max-width: 300px;"> -->
            <i-Form ref="currentAccount" label-position="left" :model="currentAccount" :label-width="80">
              <Form-Item class="mg_b_10" label="用户名: " prop="UserName">
                  <i-Input v-model="currentAccount.UserName" @on-enter='currentAccount.onUserNameonEnter' placeholder="Enter your name" style="max-width: 160px;"></i-Input>
              </Form-Item>
              <Form-Item class="mg_b_10" label="密码: " prop="UserPWD">
                <a @click='currentAccount.onUpdataPWD' href="javascript:void(0);" >更改密码</a>
              </Form-Item>
              <Form-Item class="mg_b_10" label="用户类型: " prop="usertype">
                {{currentAccount.UserTypeDesc}}
              </Form-Item>
              <Form-Item class="mg_b_10" label="创建时间: " prop="cttime">
                {{currentAccount.CtTime}}
              </Form-Item>
            </i-Form>
          <!-- </div> -->
        </Tab-Pane>
        <Tab-Pane v-if="currentAccount.UserType=='1'" name='userManage' label="账户管理">
          <div style="padding: 5px 0px;">
            <div>
                <i-button type="default" v-show="userManage.shows.add" @click="addUser">新增</i-button>
                <i-button type="default" v-show="userManage.shows.edit" @click="editUser">修改</i-button>
                <i-button type="default" v-show="userManage.shows.del" @click="delUser">删除</i-button>
            </div>
          </div>
          <i-table ref="userManage" v-minus-height="90" :loading="userManage.loading" :columns="userManage.columns" :data="calcUserManagePageDatas"
          highlight-row="true" @on-row-click="userManage.onRowClick" @on-selection-change="userManage.onSelectionChange" ></i-table>
          <Page show-total :total="userManage.datas.length" size="small" :current='userManage.currentPageIndex' :page-size="userManage.pageSize" style="line-height: 45px;background: #FFF;float: right;padding: 0px 45px;" @on-change="function(val){userManage.currentPageIndex=val;}"></Page>
        </Tab-Pane>
      </Tabs>
      <!-- 编辑用户 -->
      <Drawer :title="userManage.userEdit.isAdd?'新增用户':'修改用户'" width="450px" :closable="false" v-model="userManage.userEdit.show">
        <i-Form ref="useredit" label-position="left" :model="userManage.userEdit" :label-width="80">
          <Form-Item class="mg_b_10" label="登陆ID: " prop="UserID">
            <i-Input v-if='userManage.userEdit.isAdd' v-model="userManage.userEdit.UserID" placeholder="Enter your user ID"></i-Input>
              <span v-else>{{userManage.userEdit.UserID}}</span>
          </Form-Item>
          <Form-Item class="mg_b_10" label="用户名: " prop="UserName">
              <i-Input v-model="userManage.userEdit.UserName" placeholder="Enter your name"></i-Input>
          </Form-Item>
          <Form-Item class="mg_b_10" label="密码: " prop="UserPWD">
            <i-Input v-model="userManage.userEdit.UserPWD" placeholder="Enter your password" type='password'></i-Input>
          </Form-Item>
          <Form-Item class="mg_b_10" label="用户类型: " prop="usertype">
            <!-- {{userManage.userEdit.UserTypeDesc}} --> 普通用户
          </Form-Item>
        </i-Form>
        <div>
          <i-button class="fr mg_l_10" type='primary' @click='onSaveUser'>确定</i-button>
          <i-button class="fr" type='default' @click='userManage.userEdit.show=false'>关闭</i-button>
        </div>
      </Drawer>
    </div>
  </template>
  
  
</body>
<script type="text/javascript">
  // 文件列表模板
  var fsList = Vue.extend({
    template: "#fslist",
    data: function( ){
      var _ = this;
      return {
        fsCopyFile: {
          showDailog: false,
          srcPaths: [],
          destPath: "",
          copySettings: {
            ignore: false,
            replace: false,
          },
        },
        fsMoveFile: {
          showDailog: false,
          srcPaths: [],
          destPath: "",
          moveSettings: {
            ignore: false,
            replace: false,
          },
        },
        fsSelector: {
          operationObj: false,
          showDailog: false,
          selectFile: true,
          selectDir: true,
          selectMuti: true,
          startPath: "/",
        },
        fsAddress: {
          rootPath:"/",
          rootname:"根目录",
          loadPath:""
        },
        fsUpload: {
          max: 5,
          load: 0,
          index: 0,
          showDrawer: false,
          files: [],
        },
        loading: false,
        fsColumns:[
          {
              type: 'selection',
              width: 60,
              align: 'center',
          },
          {
              title: '文件名称',
              key: 'Path',
              render:function (h, params){
                return h("fs-fileicon", {
                  props:{
                    node: params.row,
                    isEditor: params.row.showRename?true:false
                  },
                  on:{
                    click: _.doOpen,
                    doRename: function(path, name){
                      _.onRenameAfter(params.index, params.row, name);
                    }
                  }
                });
              }
          },
          {
              title: '修改时间',
              key: 'CtTime',
              render:function (h, params){
                return h("span", $utils.long2Time(params.row.CtTime));
              }
          },
          {
              title: '文件大小',
              key: 'FileSize',
              render:function (h, params){
                if( params.row.IsFile ){
                  return h("span", $utils.formatSize(params.row.FileSize));
                }else{
                  h("span", "");
                }
              }
          }
        ],
        fsData:[],
        fsData_All: [],
        fsData_Total: 0,
        fsData_PageSize: 60,
        fsData_CurrentPageIndex: 1,
        fsOperationButtons:{
          shows: {
            newFolder: true,
            upload: false,
            download:false,
            rename: false,
            delete: false,
            move: false,
            copy: false,
          }
        }
      }
      },
      computed: {
      },
      methods: {
        doRefresh: function( ){
           this.doLoadData( this.fsAddress.loadPath );
        },
        loadDatePage: function( index ){
          this.fsData_Total = this.fsData_All.length;
          this.fsData_CurrentPageIndex = index?index:1;
          var _end   = this.fsData_CurrentPageIndex*this.fsData_PageSize;
          var _start = (this.fsData_CurrentPageIndex-1)*this.fsData_PageSize;
          this.fsData = this.fsData_All.slice(_start>0?_start:0, _end);
        },
        doLoadData: function( path ){
          if( this.loading ){ return; }
          var _ = this;
          _.loading = true;
          this.onSelectionChange([], {});
          $fsApi.List( path ).then(function( data ){
            _.fsData_All = JSON.parse(data);
            _.fsData_CurrentPageIndex = 1;
            _.loadDatePage( );
            _.loading = false;
          }).catch(function(err){
            _.loading = false;
            _.$Message.error(err.toString( ));
          });
        },   

        /* 重命名 */
        doRename: function( index, row, name ){
          row.showRename = false;
          this.$set(this.fsData, index, row);
          var _ = this;
          $fsApi.Rename(row.Path, name).then(function( ){
            _.$Message.info("操作成功");
            _.doRefresh( );
          }).catch(function( err ){
            _.$Message.error("操作失败: "+err.toString( ));
            _.doRefresh( );
          });
        },
        /** 新建文件夹 */
        doNewFolder: function( index, row, name ){
          var _ = this;
          $fsApi.NewFolder(this.fsAddress.loadPath+"/"+name).then(function( ){
            _.$Message.info("操作成功");
            _.doRefresh( );
          }).catch(function( err ){
             _.$Message.error("操作失败: "+err.toString( ));
             _.doRefresh( );
          });
        },
        /* 删除文件|文件夹 */
        doDelete: function( ){
          var select = this.$refs.fsSelection.getSelection( );
          if( !select || select.length ==0 ){
            return;
          }
          var del_loading = this.$Message.loading({
              content: "正在删除...",
              duration: 0
          });
          var errs = [];
          var _ = this;
          function loop( i ){
            if( !i ){ i = 0; }
            if( i == select.length ){ 
              del_loading( ); 
              _.doRefresh( );
              if( errs && errs.length > 0 ){
                _.$Message.error({
                    content: errs.join("</br>"),
                    duration: 5
                });
              }
              return; 
            }
            $fsApi.Delete(select[i].Path).then(function( ){
              setTimeout(function( ){
                loop( ++i );
              });
            }).catch(function(err){
              errs.push( select[i].Path+"删除失败: "+ err );
              loop( ++i );
            });
          };
          loop( 0 );
        },
        /* 开始复制 */
        doCopy: function( ){
          // 设置源路径
          this.fsCopyFile.srcPaths = this.$refs.fsSelection.getSelection( );
          // 文件选择框
          this.fsSelector.operationObj = this.fsCopyFile;
          this.fsSelector.selectFile = false;
          this.fsSelector.selectDir  = true;
          this.fsSelector.selectMuti = false;
          this.fsSelector.startPath  = this.fsAddress.loadPath;
          this.fsSelector.showDailog = true;
        },
        /* 开始移动 */
        doMove: function( ){
            // 设置源路径
            this.fsMoveFile.srcPaths = this.$refs.fsSelection.getSelection( );
            // 文件选择框
            this.fsSelector.operationObj = this.fsMoveFile;
            this.fsSelector.selectFile = false;
            this.fsSelector.selectDir  = true;
            this.fsSelector.selectMuti = false;
            this.fsSelector.startPath  = this.fsAddress.loadPath;
            this.fsSelector.showDailog = true;
        },
        /* 下载单个|多个文件 */
        doDownload: function( ){
          var select = this.$refs.fsSelection.getSelection( );
          if( !select || select.length == 0 ){
            return;
          }
          var _ = this;
          for (var i = select.length - 1; i >= 0; i--) {
            if( !select[i].IsFile ){ continue; }
            $fsApi.GetDownloadUrl( select[i].Path ).then(function(data){
              _.$nextTick(function( ){
                var download = document.createElement("iframe");
                download.src = data;
                document.body.appendChild(download);
              });
            }).catch(function(err){
              _.$Message.error("操作失败: "+select[i].Path+", "+err.toString( ));
            });
          }
        },
        /* 重命名文件|文件夹 */
        onRename: function( ){
          var select = this.$refs.fsSelection.getSelection( );
          if( !select || select.length == 0 ){
            return;
          }
          select[0].showRename = true;
          for (var i = 0; i < this.fsData.length; i++) {
            if(this.fsData[i].Path == select[0].Path){
              this.$set(this.fsData, i, select[0]);
            }
          }
        },
        /* 打开文件 */
        doOpen: function( node ){
          if( !node.IsFile ){
            this.goToPath( node.Path )
          }else{
            var _ = this;
            $preview.doPreview(node.Path).catch(function(err){
              $fsApi.GetSteamUrl( node.Path ).then(function(data){
                _.$nextTick(function( ){
                  window.open( data )
                });
              }).catch(function(err){
                _.$Message.error("操作失败: "+node.Path+", "+err.toString( ));
              });
            });
            
          }
        },
        /** 重命名|新建文件夹二合一事件 */
        onRenameAfter: function( index, row, name ){
          if(row.IsNewFolder){
            this.doNewFolder(index, row, name);
          }else{
            this.doRename(index, row, name);
          }
        },
        /** 新建文件 */
        onNewFolder: function( ){
          var temp = this.fsData;
          temp.unshift({
            "Path": "",
            "IsFile": false,
            "IsNewFolder": true,
            "showRename": true,
          });
          this.$set(this, "fsData", temp);
        },
        // 上传-触发选择文件
        doSelectFiels: function( ev ){
          var _ = this;
          $utils.addEvent(this.$refs.upload_selector_file, "change", function( ev_data ){
            if( ev_data.target.files ){
              for(var i = 0; i < ev_data.target.files.length; i++){
                var fs = ev_data.target.files[i];
                fs._upload = {
                  base: _.fsAddress.loadPath,
                  index: _.fsUpload.files.length,
                  updater: false,
                  ps: 0,
                };
                _.fsUpload.files.push( fs );
                _.doStartUpload( );
              }
            }
            _.$refs.upload_selector_file.value = ""
          }, {once: true});
          $utils.triggerMouseEvent(this.$refs.upload_selector_file, "click");
        },
        // 上传-触发上传动作
        doStartUpload: function( ){
          if( this.fsUpload.files && this.fsUpload.files.length > 0 ){
            if( this.fsUpload.load >= this.fsUpload.max || this.fsUpload.index >= this.fsUpload.files.length){
              return;
            }
            this.fsUpload.load ++;
            var file = this.fsUpload.files[this.fsUpload.index++];
            if( file._upload.removed ){
              this.fsUpload.load --;
              this.$nextTick(this.doStartUpload);
              return;
            }
            // file._upload.index = this.fsUpload.index-1;
            var _ = this;
            let opts = {
              form: { },
              header: { },
              progress: function( e ){
                // 数据源为数组, 需要直接设置数组
                file._upload.ps = Math.round((e.loaded/e.total)*1000)/10;
                _.$set(_.fsUpload.files, file._upload.index, file);
              },
              error: function( e ){
                file._upload.err = "上传失败";
                _.$set(_.fsUpload.files, file._upload.index, file);
              },
              abort: function( e ){
                file._upload.err = "上传取消";
                _.$set(_.fsUpload.files, file._upload.index, file);
              },
              loadstart: function( e ){ },
              loadend: function( e ){
                _.fsUpload.load--;
                file._upload.ended = true;
                _.$nextTick(function( ){
                  _.doStartUpload( );
                });
              }
            };
            // 预备开始
            file._upload.started = true;
            $fsApi.GetUploadUrl(file._upload.base+"/"+file.name).then(function(url){
              file._upload.updater = $utils.uploadByFormData(url, file, opts);
              file._upload.updater.start( );
            }).catch(function(err){
              opts.error(err);
              opts.loadend();
            });
          }
        },
        // 上传 - 移除任务
        removeTask: function( index ){
          var file = this.fsUpload.files[index];
          if( file ){
            // 正在传输
            if( !file._upload.ended && file._upload.started ){
              file._upload.updater.abort( );
            }
            file._upload.removed = true;
            this.$set(this.fsUpload.files, index, file);
          }
        },
        // 上传 - 监听拖拽
        doListenDrag: function( ){
          var _ = this;
          this.$nextTick(function( ){
            if( _.$refs.uploadDrag ){
              _.$refs.uploadDrag.ondrop = function( evn ){
                evn.preventDefault( );
                var fileList = evn.dataTransfer.files;
              }; 
            }
          });
            
        },

        /* 选择单个文件夹 - OK */
        onSelectedFile: function( rows ){
          this.fsSelector.showDailog = false;
          if( rows && rows[0] && rows[0].Path && rows[0].Path.length > 0 ){
            if( this.fsSelector.operationObj  ){
              // this.fsCopyFile.destPath = rows[0].Path;
              // this.fsCopyFile.showDailog = true;
              this.fsSelector.operationObj.destPath = rows[0].Path;
              this.fsSelector.operationObj.showDailog = true;
            }
          }
        },
        /* 选择单个文件夹 - Cancel */
        onSelectCancel: function( ){
          this.fsSelector.showDailog = false;
        },
        even_StopCopy: function( ){
          this.fsCopyFile.showDailog = false;
        },
        even_EndCopy: function( ){
          this.fsCopyFile.showDailog = false;
        },
        even_StopMove: function( ){
          this.fsMoveFile.showDailog = false;
          this.doRefresh( );
        },
        even_EndMove: function( ){
          this.fsMoveFile.showDailog = false;
          this.doRefresh( );
        },
        goToPath: function( path ){
          if( this.fsAddress.loadPath != path ){
            this.fsAddress.loadPath = path;
          }else{
            this.doLoadData( path );
          }
        },
        // 点击一行
        onRowClick: function(row, index){
          for (var i = 0; i < this.fsData.length; i++) {
            if( this.fsData[i]._checked && index != i ){
              this.$set( this.fsData[i], "_checked", false);
            }
          }
          this.$set( this.fsData[index], "_checked", true);
          this.onSelectionChange([row], row);
        },
        // 当Checkbox数据发生变化, 则需要刷新按钮
        onSelectionChange: function( selection, row ){
          // 处理按钮是否显示
          {
            this.fsOperationButtons.shows.download = false;
            this.fsOperationButtons.shows.rename = false;
            this.fsOperationButtons.shows.delete = false;
            this.fsOperationButtons.shows.move = false;
            this.fsOperationButtons.shows.copy = false;
            var len_selection = selection.length;
            // 选择一个或者以上
            if( len_selection >= 1){
              this.fsOperationButtons.shows.download = true;
              this.fsOperationButtons.shows.delete = true;
              this.fsOperationButtons.shows.move = true;
              this.fsOperationButtons.shows.copy = true;

            }
            // 只选择了一个
            if( len_selection == 1 ){
              this.fsOperationButtons.shows.rename = true;
            }
          }
        },
      },
      mounted: function( ){ },
      created: function( ){
        this.doListenDrag( );
        this.goToPath(this.fsAddress.rootPath);
        this.fsOperationButtons.shows.upload = true;
      },
      watch:{
        'fsAddress.loadPath':function(n, o){
          this.doLoadData( n );
        }
      }
  });
  // 设置
  var settings = Vue.extend({
    template:"#settings",
    data: function(){
      let _ = this;
      return {
        UserTypes: {
          '1': '管理员',
          '0': '普通用户',
        },
        currentTab: 'currentAccount',
        // 账户管理
        userManage: {
          loading: false,
          datas: [],
          currentPageIndex: 1,
          pageSize: 60,
          shows: {
            add: true,
            del: false,
            edit: false,
          },
          userEdit: {
            show: false,
            isAdd: false,
            UserID: '',
            UserType: '',
            UserName: '',
            UserPWD: '',
          },
          columns: [
            {
                type: 'selection',
                width: 60,
                align: 'center',
            },
            {
              title: 'UserName',
              key: 'UserName',
            },
            {
                title: 'UserType',
                key: 'UserTypeDesc',
            },
            {
                title: 'CtTime',
                key: 'CtTime',
            },
          ],
          // 点击一行
          onRowClick: function(row, index){
            for (var i = 0; i < _.userManage.datas.length; i++) {
              if( _.userManage.datas[i]._checked && index != i ){
                _.$set( _.userManage.datas[i], "_checked", false);
              }
            }
            _.$set( _.userManage.datas[index], "_checked", true);
            _.userManage.onSelectionChange([row], row);
          },
          // 当Checkbox数据发生变化, 则需要刷新按钮
          onSelectionChange: function( selection, row ){
            _.userManage.shows.add = true;
            _.userManage.shows.del = false;
            _.userManage.shows.edit = false;
            var len_selection = selection.length;
            // 选择一个或者以上
            if( len_selection >= 1){
              _.userManage.shows.del = true;
            }
            // 只选择了一个
            if( len_selection == 1 ){
              _.userManage.shows.edit = true;
            }
          },         
        },
        // 账户信息
        currentAccount: {
          UserID: '',
          UserType: '',
          UserTypeDesc: '',
          UserName: '',
          UserPWD: '',
          CtTime: '',
          ruleValidate: {
            UserName: [ {required: true}, ],
          },
          onUserNameonEnter: function(){
            if(!_.currentAccount.UserName){
              _.$Message.error('不能为空'); return;
            }
            $userApi.updateUserName(_.currentAccount.UserID, _.currentAccount.UserName).then(function(data){
              _.$Message.info("操作成功");
              _.$root.doInitCurrentAccountInfo();
              // _.doBuildAccountInfo();
            }).catch(function(err){
              _.$Message.error("操作失败");
              _.$root.doInitCurrentAccountInfo();
              // _.doBuildAccountInfo();
            });
          },
          onUpdataPWD: function(){
            let newpwd = '';
            _.$Modal.info({
              title: '更改密码',
              render: function(h){
                return h('Input', {
                  props: {
                    type: 'password',
                    value: '',
                    autofocus: true,
                    placeholder: 'Please enter your password...'
                  },
                  on: {
                    input: function(val) {
                      newpwd = val;
                    }
                  }
                })
              },
              onOk: function(){
                $userApi.updateUserPwd(_.currentAccount.UserID, newpwd).then(function(data){
                  _.$Message.info('操作成功');
                }).catch(function(err){
                  _.$Message.error("操作失败");
                });
              },
            })
          },
        },
      };
    },
    computed: {
      calcUserManagePageDatas: function( ){
        var _end   = this.userManage.currentPageIndex*this.userManage.pageSize;
        var _start = (this.userManage.currentPageIndex-1)*this.userManage.pageSize;
        return this.userManage.datas.slice(_start>0?_start:0, _end);
      },
    },
    methods: {
      // 加载账户信息
      doBuildAccountInfo: function(data){
        if(data){
          data.UserTypeDesc = this.UserTypes[data.UserType]?this.UserTypes[data.UserType]:'未知类型';
        }
      },
      // doListAllUsers
      doListAllUsers: function(){
        let _ = this;
        _.userManage.datas = [];
        _.userManage.loading = true;
        _.userManage.currentPageIndex = 1;
        $userApi.listAllUsers().then(function(datas){
          if(datas){
            datas = JSON.parse(datas);
            for(let i=0; i<datas.length; i++){
              _.doBuildAccountInfo(datas[i]);
            }
          }
          _.$set(_.userManage, 'datas', datas);
           _.userManage.loading = false;
        }).catch(function(err){
          _.$Message.error(err.toString());
           _.userManage.loading = false;
        })
      },
      addUser: function(){
        this.userManage.userEdit.isAdd = true;
        this.userManage.userEdit.UserID = '';
        this.userManage.userEdit.UserName = '';
        this.userManage.userEdit.UserType = '';
        this.userManage.userEdit.UserPWD = '';
        this.userManage.userEdit.show = true;
      },
      delUser: function(){
        let rows = this.$refs.userManage.getSelection( );
        if(rows){
          try{
            for(let i=0; i<rows.length; i++){
              $userApi.sync.delUser(rows[i].UserID)
            }
            this.$Message.info('操作成功');
          }catch(err){
            this.$Message.error(err.toString());
          }
          this.doListAllUsers();
        }
      },
      editUser: function(){
        let rows = this.$refs.userManage.getSelection( );
        if(rows && rows.length == 1){
          this.userManage.userEdit.isAdd = false;
          this.userManage.userEdit.UserPWD = '';
          this.userManage.userEdit.UserID = rows[0].UserID;
          this.userManage.userEdit.UserName = rows[0].UserName;
          this.userManage.userEdit.UserType = rows[0].UserType;
          this.userManage.userEdit.show = true;
        }
      },
      onSaveUser: function(){
        if(!this.userManage.userEdit.UserID){
          this.$Message.error('用户ID不能为空'); return;
        }
        if(!this.userManage.userEdit.UserName){
          this.$Message.error('用户名不能为空'); return;
        }
        if(this.userManage.userEdit.isAdd){
          let _ = this;
          $userApi.addUser(this.userManage.userEdit.UserID, this.userManage.userEdit.UserName, this.userManage.userEdit.UserPWD).then(function(data){
            _.$Message.info('操作成功');
            _.doListAllUsers( );
            _.userManage.userEdit.show = false;
          }).catch(function(err){
            _.$Message.error(err.toString());
            _.doListAllUsers( );
            _.userManage.userEdit.show = false;
          });
        }else{
          try{
            $userApi.sync.updateUserName(this.userManage.userEdit.UserID, this.userManage.userEdit.UserName);
            $userApi.sync.updateUserPwd(this.userManage.userEdit.UserID, this.userManage.userEdit.UserPWD);
            this.$Message.info('操作成功');
          }catch(err){
            this.$Message.error(err.toString());
          }
          this.doListAllUsers( );
          this.userManage.userEdit.show = false;
        }
      },
    },
    created: function(){
      this.doBuildAccountInfo(this.$root.$data.currentAccount);
      this.$set(this, 'currentAccount', $utils.extendAttrs(this.currentAccount, this.$root.$data.currentAccount));
    },
    watch: {
      currentTab: function(n, o){
        if(n == 'userManage'){
          this.doListAllUsers();
        }
      }
    }
  });
</script>
<script type="text/javascript">
  // 页面路由
  var router = new VueRouter({
    routes: [
      { path: '/files', component: fsList },
      { path: '/settings', component: settings },
    ]
  });

  var v = new Vue({
    router : router,
    data: function( ){
      return {
        isCollapsed: false,
        loading: true,
        currentAccount: {
          UserType: '',
          UserName: '',
          CtTime: '',
        },
    }
    },
    computed: {
        menuitemClasses:function(){
            return [
                'menu-item',
                this.isCollapsed ? 'collapsed-menu' : ''
            ]
        }
    },
    methods: {
      onDropdownClick: function(name){
        if(name =='logout'){
          $userApi.logout().then(function(data){
            $apitools.destroySession();
            window.location.replace('/');
          }).catch(function(err){
            v.$Message.error(err.toString());
          })
        }
      },
       // 加载当前账户信息
       doInitCurrentAccountInfo: function( ){
        let _ = this;
        let session = $apitools.getSession();
        if(session && session.UserID){
          $userApi.queryuser(session.UserID).then(function( data ){
            if(data){
              _.$set(_, 'currentAccount', JSON.parse(data));
            }
          }).catch(function(err){
            _.$Message.error(err.toString());
          })
        }
      }
    },
    mounted: function( ){
      
    },
    created: function( ){
      this.doInitCurrentAccountInfo();
      this.$router.push("/files");
    },
    watch:{
      
    }
  }).$mount('#app');

</script>

</html>